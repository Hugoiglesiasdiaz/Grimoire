<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimoire - Inicio</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <header class="glass-header">
        <nav class="nav-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='Icon.png') }}" class="logo-icon">
                <h1>Grimoire</h1>
            </div>
            <ul class="nav-links">
                <li><a href="/" class="active">Inicio</a></li>
                <li><a href="/about">Acerca de</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="content-grid">
            <section class="card hero-section">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flashes">
                    {% for category, message in messages %}
                    <div class="flash {{ category }}">
                        <div class="flash-content">
                            <i data-lucide="{{ 'check-circle' if category == 'success' else 'alert-circle' }}"></i>
                            <span>{{ message }}</span>
                        </div>
                        <button type="button" class="icon-btn close-btn" onclick="this.parentElement.remove();"
                            aria-label="Cerrar">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <div class="hero-content">
                    <h2>Bienvenido a Grimoire</h2>
                    <p class="text-muted">Una plataforma ágil y moderna para la gestión de archivos, construida con la
                        robustez de Python y la elegancia del minimalismo.</p>
                </div>

                <!-- Search Bar -->
                <div class="search-container central">
                    <div class="search-box premium">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="landingSearch" placeholder="Busca algo en el Grimoire..."
                            autocomplete="off">
                        <button id="searchBtn" class="btn btn-primary">Buscar</button>
                    </div>
                </div>

            </section>

            <!-- Restored Upload Sidebar -->
            <aside class="upload-sidebar">
                <div class="card upload-card">
                    <div class="card-header">
                        <i data-lucide="cloud-upload" class="section-icon"></i>
                        <h3>Subir Archivos</h3>
                    </div>

                    <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                        <div class="drop-zone" id="dropZone">
                            <i data-lucide="upload-cloud" class="upload-icon"></i>
                            <p>Arrástralos aquí o <span>haz clic para buscar</span></p>
                            <input type="file" name="file" id="fileInput" multiple required class="hidden-input">
                        </div>

                        <ul id="fileList" class="file-list empty">
                            <li class="empty-state">No hay archivos seleccionados</li>
                        </ul>

                        <button type="submit" class="btn btn-primary w-full">
                            <span>Subir Archivos</span>
                            <i data-lucide="arrow-up-right"></i>
                        </button>
                    </form>
                </div>
            </aside>
        </div>
    </main>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-logo">
                <i data-lucide="book-open" class="text-muted"></i>
                <span class="text-muted">&copy; 2026 Grimoire.</span>
            </div>
            <div class="footer-info">
                <span class="text-muted text-sm">v1.0.0</span>
                <span class="separator">|</span>
                <p class="text-muted text-sm">Poderosa gestión de documentos.</p>
            </div>
        </div>
    </footer>

    <script>
        lucide.createIcons();

        const landingSearch = document.getElementById('landingSearch');
        const searchBtn = document.getElementById('searchBtn');

        function executeSearch() {
            const query = landingSearch.value.trim();
            if (query) {
                window.location.href = `/search?q=${encodeURIComponent(query)}`;
            }
        }

        searchBtn.addEventListener('click', executeSearch);
        landingSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeSearch();
        });

        // --- Restored & Enhanced Upload Logic ---
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const dropZone = document.getElementById('dropZone');
        const uploadForm = document.querySelector('.upload-form');
        let dataTransfer = new DataTransfer();

        dropZone.addEventListener('click', () => fileInput.click());

        // Manejo de Drag & Drop
        ['dragover', 'dragenter'].forEach(evt => {
            dropZone.addEventListener(evt, e => {
                e.preventDefault();
                dropZone.classList.add('drag-active');
            });
        });

        ['dragleave', 'dragend', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, e => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
            });
        });

        dropZone.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            if (files.length) handleFiles(files);
        });

        fileInput.addEventListener('change', function () {
            handleFiles(this.files);
        });

        function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                dataTransfer.items.add(files[i]);
            }
            fileInput.files = dataTransfer.files;
            updateFileList();
        }

        function updateFileList() {
            fileList.innerHTML = '';
            if (dataTransfer.files.length === 0) {
                fileList.classList.add('empty');
                fileList.innerHTML = '<li class="empty-state">No hay archivos seleccionados</li>';
                return;
            }
            fileList.classList.remove('empty');
            for (let i = 0; i < dataTransfer.files.length; i++) {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="file-info">
                        <i data-lucide="${getFileIcon(dataTransfer.files[i].name)}" class="file-type-icon text-muted"></i>
                        <div class="file-text-container">
                            <span class="file-name">${dataTransfer.files[i].name}</span>
                            <span class="file-size text-muted text-sm">${(dataTransfer.files[i].size / 1024).toFixed(1)} KB</span>
                        </div>
                    </div>
                `;
                fileList.appendChild(li);
            }
            lucide.createIcons();
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(ext)) return 'image';
            if (['pdf', 'doc', 'docx', 'txt', 'md'].includes(ext)) return 'file-text';
            if (['py', 'js', 'html', 'css', 'json'].includes(ext)) return 'file-code';
            return 'file';
        }

        // Envío asíncrono para incluir metadatos de fecha local
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const files = dataTransfer.files;
            if (files.length === 0) return;

            const formData = new FormData();
            const localDates = [];

            for (let i = 0; i < files.length; i++) {
                formData.append('file', files[i]);
                // Capturamos lastModified (proxy para fecha creación/modificación local)
                const dateObj = new Date(files[i].lastModified);
                localDates.push({
                    name: files[i].name,
                    lastModified: dateObj.toISOString().split('T')[0]
                });
            }

            formData.append('local_metadata', JSON.stringify(localDates));

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    window.location.reload();
                }
            } catch (err) {
                console.error("Error subiendo archivos:", err);
                alert("Hubo un error al subir los archivos.");
            }
        });
    </script>
</body>

</html>